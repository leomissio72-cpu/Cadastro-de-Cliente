<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Pacientes</title>
  <style>
    :root {
      --cor-primaria: #0066ff;
      --cor-secundaria: #f5f7fb;
      --cor-sucesso: #28a745;
      --cor-erro: #dc3545;
      --cor-texto: #333;
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }

    body {
      background: var(--cor-secundaria);
      padding: 40px;
      color: var(--cor-texto);
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 30px;
      color: var(--cor-primaria);
    }

    form, .dados {
      background: #fff;
      padding: 25px 30px;
      border-radius: var(--radius);
      box-shadow: 0 6px 15px rgba(0,0,0,0.08);
      max-width: 650px;
      margin: 20px auto;
      transition: transform .2s ease;
    }

    form:hover, .dados:hover {
      transform: translateY(-3px);
    }

    label {
      font-weight: 600;
      color: #444;
      margin-top: 15px;
      display: block;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color .3s;
    }

    input:focus, textarea:focus, select:focus {
      border-color: var(--cor-primaria);
      outline: none;
    }

    button {
      display: inline-block;
      width: 100%;
      margin-top: 25px;
      padding: 12px;
      font-weight: bold;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background .3s ease;
    }

    #buscaForm button { background: var(--cor-primaria); }
    #buscaForm button:hover { background: #0048b8; }

    #novaSessao button { background: var(--cor-sucesso); }
    #novaSessao button:hover { background: #1f8c3b; }

    h2, h3 {
      color: var(--cor-primaria);
      margin-top: 25px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 5px;
    }

    .dados p {
      margin: 8px 0;
      font-size: 0.95rem;
    }

    .historico {
      margin-top: 15px;
      border-radius: 8px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border-bottom: 1px solid #eee;
      padding: 10px;
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      background: #f0f4ff;
      color: #0048b8;
      font-weight: 600;
    }

    tr:hover {
      background: #f9f9f9;
    }

    #mensagem {
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
    }

    .status-sim { color: var(--cor-sucesso); font-weight: bold; }
    .status-nao { color: var(--cor-erro); font-weight: bold; }
  </style>
</head>
<body>
  <h1>Consulta e Cadastro de Pacientes</h1>

  <form id="buscaForm">
    <label>Buscar paciente pelo nome:</label>
    <input type="text" id="buscaNome" required placeholder="Digite o nome completo">
    <button type="submit">üîç Buscar</button>
  </form>

  <div id="dadosPaciente" class="dados" style="display:none;">
    <h2>Dados do Paciente</h2>
    <p><b>Nome:</b> <span id="pNome"></span></p>
    <p><b>CPF:</b> <span id="pCPF"></span></p>
    <p><b>Tratamento:</b> <span id="pTratamento"></span></p>
    <p><b>Pre√ßo da Sess√£o:</b> R$ <span id="pPreco"></span></p>
    <p><b>Sess√µes neste m√™s:</b> <span id="pSessoes"></span></p>
    <p><b>Total no m√™s:</b> R$ <span id="pTotal"></span></p>

    <h3>Hist√≥rico de Sess√µes</h3>
    <div class="historico">
      <table id="tabelaHistorico">
        <thead>
          <tr>
            <th>Data</th>
            <th>Anota√ß√£o</th>
            <th>Compareceu?</th>
          </tr>
        </thead>
        <tbody id="pHistorico"></tbody>
      </table>
    </div>

    <h3>Registrar Nova Sess√£o</h3>
    <form id="novaSessao">
      <input type="hidden" name="nome" id="nNome">
      <input type="hidden" name="cpf" id="nCPF">
      <input type="hidden" name="data_nascimento" id="nNasc">
      <input type="hidden" name="tratamento" id="nTrat">
      <input type="hidden" name="preco" id="nPreco">

      <label>Data da Sess√£o:</label>
      <input type="date" name="data_sessao" required>

      <label>Anota√ß√£o (opcional):</label>
      <textarea name="anotacao" rows="3" placeholder="Anota√ß√µes da sess√£o..."></textarea>

      <label>Compareceu √† consulta?</label>
      <select name="compareceu" required>
        <option value="">Selecione</option>
        <option value="Sim">Sim</option>
        <option value="N√£o">N√£o</option>
      </select>

      <button type="submit">üíæ Salvar Sess√£o</button>
    </form>
    <p id="mensagem"></p>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxwiOvj9ffd8Tn2SA0CaATKduzRocduv9Cd6pwdwrVGzDuaScc-2qpTc2_XLF7PkyrX/exec";

    document.getElementById("buscaForm").addEventListener("submit", async e => {
      e.preventDefault();
      const nome = document.getElementById("buscaNome").value.trim();
      if (!nome) return;

      document.getElementById("dadosPaciente").style.display = "none";
      document.getElementById("pHistorico").innerHTML = "<tr><td colspan='3'>üîÑ Buscando...</td></tr>";

      try {
        const res = await fetch(${scriptURL}?nome=${encodeURIComponent(nome)});
        const dados = await res.json();

        if (dados.erro) {
          alert(dados.erro);
          return;
        }

        const p = dados.paciente;
        document.getElementById("dadosPaciente").style.display = "block";
        document.getElementById("pNome").textContent = p.nome;
        document.getElementById("pCPF").textContent = p.cpf;
        document.getElementById("pTratamento").textContent = p.tratamento;
        document.getElementById("pPreco").textContent = parseFloat(p.preco).toFixed(2);
        document.getElementById("pSessoes").textContent = dados.sessoesNoMes;
        document.getElementById("pTotal").textContent = parseFloat(dados.totalMes).toFixed(2);

        document.getElementById("nNome").value = p.nome;
        document.getElementById("nCPF").value = p.cpf;
        document.getElementById("nNasc").value = p.data_nascimento;
        document.getElementById("nTrat").value = p.tratamento;
        document.getElementById("nPreco").value = p.preco;

        const historicoHTML = dados.historico.map(h => `
          <tr>
            <td>${h.data_sessao}</td>
            <td>${h.anotacao || "(sem anota√ß√£o)"}</td>
            <td class="${h.compareceu === 'Sim' ? 'status-sim' : 'status-nao'}">${h.compareceu || "N√£o informado"}</td>
          </tr>
        `).join("");
        document.getElementById("pHistorico").innerHTML = historicoHTML || "<tr><td colspan='3'>Nenhum hist√≥rico encontrado.</td></tr>";
      } catch (error) {
        alert("Erro ao conectar com o servidor.");
      }
    });

    document.getElementById("novaSessao").addEventListener("submit", async e => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      formData.append("acao", "registrarSessao");

      const msg = document.getElementById("mensagem");
      msg.textContent = "Enviando...";
      msg.style.color = "blue";

      try {
        const res = await fetch(scriptURL, { method: "POST", body: formData });
        const result = await res.json();
        if (result.sucesso) {
          msg.textContent = "‚úÖ Sess√£o registrada com sucesso!";
          msg.style.color = "green";
          form.reset();
        } else {
          msg.textContent = result.erro || "Erro ao registrar sess√£o.";
          msg.style.color = "red";
        }
      } catch {
        msg.textContent = "‚ùå Falha na comunica√ß√£o com o servidor.";
        msg.style.color = "red";
      }
    });
  </script>
</body>
</html>
